# Test script for Task Cockpit (Sprint 8)
# Usage: .\test-task-cockpit.ps1

$baseUrl = "http://localhost:3000"
$token = $env:APP_ADMIN_TOKEN

if (-not $token) {
    Write-Host "ERROR: APP_ADMIN_TOKEN not set" -ForegroundColor Red
    exit 1
}

Write-Host "`n=== Task Cockpit Test ===" -ForegroundColor Cyan

# 1. Fetch work queue sorted by task due
Write-Host "`n1) Work Queue (sort=taskDue)..." -ForegroundColor Gray
try {
    $response = Invoke-RestMethod `
        -Uri "$baseUrl/api/admin/leads/work-queue?sort=taskDue" `
        -Headers @{ Authorization = "Bearer $token" }

    Write-Host "Total leads: $($response.count)" -ForegroundColor Green

    $top10 = $response.items | Select-Object -First 10
    $tableData = @()
    foreach ($item in $top10) {
        $taskTitle = if ($item.nextTask) { $item.nextTask.title } else { "-" }
        $taskDue = if ($item.nextTask -and $item.nextTask.dueAt) { ([DateTime]$item.nextTask.dueAt).ToString("dd/MM HH:mm") } else { "-" }
        $auto = if ($item.nextTask -and $item.nextTask.autoGenerated) { "ðŸ§ " } else { "" }

        $tableData += [PSCustomObject]@{
            Company   = $item.company
            Tasks     = $item.openTasksCount
            NextTask  = "$auto $taskTitle".Trim()
            Due       = $taskDue
            Temp      = $item.temperature
            Status    = $item.status
        }
    }
    $tableData | Format-Table -AutoSize -Wrap

    # Summary
    $withTasks = ($response.items | Where-Object { $_.openTasksCount -gt 0 }).Count
    $overdue = ($response.items | Where-Object { $_._nextTaskOverdue }).Count
    Write-Host "Leads with tasks: $withTasks / $($response.count)" -ForegroundColor White
    Write-Host "Overdue tasks: $overdue" -ForegroundColor $(if ($overdue -gt 0) { "Red" } else { "Green" })

} catch {
    Write-Host "ERROR: $($_.Exception.Message)" -ForegroundColor Red
    exit 1
}

# 2. Complete a task (if any exist)
$leadWithTask = $response.items | Where-Object { $_.nextTask } | Select-Object -First 1
if ($leadWithTask) {
    Write-Host "`n2) Completing task for $($leadWithTask.company)..." -ForegroundColor Gray
    Write-Host "   Task: $($leadWithTask.nextTask.title)" -ForegroundColor White

    try {
        $completeResult = Invoke-RestMethod `
            -Uri "$baseUrl/api/admin/leads/$($leadWithTask.id)/tasks/complete" `
            -Method Patch `
            -Headers @{ Authorization = "Bearer $token"; "Content-Type" = "application/json" } `
            -Body (@{ taskId = $leadWithTask.nextTask.id } | ConvertTo-Json)

        Write-Host "   DONE! Task completed." -ForegroundColor Green

        # Re-query to verify count decreased
        $response2 = Invoke-RestMethod `
            -Uri "$baseUrl/api/admin/leads/work-queue?sort=taskDue" `
            -Headers @{ Authorization = "Bearer $token" }

        $updatedLead = $response2.items | Where-Object { $_.id -eq $leadWithTask.id }
        if ($updatedLead) {
            Write-Host "   Updated tasks count: $($updatedLead.openTasksCount) (was $($leadWithTask.openTasksCount))" -ForegroundColor Cyan
        }
    } catch {
        Write-Host "   ERROR: $($_.Exception.Message)" -ForegroundColor Red
    }
} else {
    Write-Host "`n2) No leads with tasks to complete." -ForegroundColor Yellow
}

Write-Host "`n=== Test Complete ===" -ForegroundColor Cyan

