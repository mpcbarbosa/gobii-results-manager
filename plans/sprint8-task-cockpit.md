# Sprint 8 â€” Task-Driven CRM Cockpit

## Overview

Sprint 8 transforms the Work Queue into a task-driven cockpit where sales users can see "what to do next" without opening each lead.

## New API Response Fields

`GET /api/admin/leads/work-queue` now returns per item:

| Field | Type | Description |
|-------|------|-------------|
| `openTasksCount` | `number` | Count of open (uncompleted) TASK activities |
| `nextTask` | `object \| null` | Earliest-due open task |
| `nextTask.id` | `string` | Task ID |
| `nextTask.title` | `string` | Task title |
| `nextTask.dueAt` | `string \| null` | Due date ISO |
| `nextTask.createdAt` | `string` | Created date ISO |
| `nextTask.autoGenerated` | `boolean` | True if created by NBA engine |
| `nextTask.metaCategory` | `string \| null` | Signal category (if auto-generated) |
| `nextTask.metaConfidence` | `string \| null` | Signal confidence (if auto-generated) |
| `_nextTaskOverdue` | `boolean` | True if nextTask.dueAt < now |

## Sort Modes

| Mode | Query | Behavior |
|------|-------|----------|
| `temperature` (default) | `?sort=temperature` | HOT â†’ WARM â†’ COLD, then signal, then score |
| `sla` | `?sort=sla` | OVERDUE â†’ WARNING â†’ OK, then temperature |
| `taskDue` | `?sort=taskDue` | Leads with tasks first â†’ overdue first â†’ soonest due â†’ temperature â†’ score |

## Efficient Query Design

Open tasks are fetched in a single batch query (`WHERE leadId IN (...)`) rather than N+1 per lead. Tasks are grouped by leadId in memory for O(1) lookup.

## UI Changes

### Work Queue
- **"Next Task" column**: Shows task title (truncated), due date, ðŸ§  badge for auto-generated, task count badge
- **"Tasks only" filter**: Checkbox to show only leads with open tasks
- **"âœ“ Done" button**: Completes the next task inline, optimistically updates count, then refetches

### Lead Detail
- Auto-generated TASKs show ðŸ§  badge + category badge + amber border (from Sprint 7)

## Testing

```powershell
$env:APP_ADMIN_TOKEN = "your-token"
.\test-task-cockpit.ps1
```
