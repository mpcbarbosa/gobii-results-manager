/**
 * Next Best Action Derivation
 *
 * Determines the recommended commercial action based on a SYSTEM signal's
 * category and confidence. Returns a structured action template with
 * title, notes, due date, and priority.
 *
 * @module lib/crm/deriveNextBestAction
 */

export type ActionPriority = "HIGH" | "MEDIUM" | "LOW";

export interface NextBestAction {
  shouldCreate: boolean;
  title: string;
  notes: string;
  dueDate: Date;
  priority: ActionPriority;
}

interface DeriveInput {
  category: string | null;
  confidence: "HIGH" | "MEDIUM" | "LOW" | null;
  ownerId: string | null;
}

function hoursFromNow(hours: number): Date {
  return new Date(Date.now() + hours * 60 * 60 * 1000);
}

function buildNotes(
  category: string | null,
  confidence: string | null,
  approach: string[],
): string {
  const timestamp = new Date().toISOString();
  const lines = [
    "### Auto-generated Next Best Action",
    "",
    `Category: ${category ?? "unknown"}`,
    `Confidence: ${confidence ?? "unknown"}`,
    `Generated at: ${timestamp}`,
    "",
    "Suggested Approach:",
    ...approach.map((a) => `- ${a}`),
    "",
    "---",
    "autoGenerated: true",
    `meta.category: ${category ?? "unknown"}`,
    `meta.confidence: ${confidence ?? "unknown"}`,
    `meta.engineVersion: 1.0`,
  ];
  return lines.join("\n");
}

const NO_ACTION: NextBestAction = {
  shouldCreate: false,
  title: "",
  notes: "",
  dueDate: new Date(),
  priority: "LOW",
};

/**
 * Derive the next best action for a lead based on a commercial signal.
 *
 * Rules (v1):
 *
 * | Category | Confidence | Action | Due | Priority |
 * |----------|-----------|--------|-----|----------|
 * | RFP | HIGH | Analisar RFP e preparar abordagem | +24h | HIGH |
 * | RFP | MEDIUM | Validar relevância do RFP | +48h | MEDIUM |
 * | * | HIGH | Contacto telefónico em 24h | +24h | HIGH |
 * | * | LOW | Qualificar oportunidade | +72h | LOW |
 * | else | else | No action | - | - |
 */
export function deriveNextBestAction(input: DeriveInput): NextBestAction {
  const { category, confidence } = input;
  const cat = category?.toUpperCase() ?? null;
  const conf = confidence?.toUpperCase() ?? null;

  // RFP + HIGH
  if (cat === "RFP" && conf === "HIGH") {
    return {
      shouldCreate: true,
      title: "Analisar RFP e preparar abordagem",
      dueDate: hoursFromNow(24),
      priority: "HIGH",
      notes: buildNotes(cat, conf, [
        "Review signal details and RFP requirements",
        "Validate technical fit with our offering",
        "Identify decision maker and procurement timeline",
        "Prepare initial outreach with value proposition",
      ]),
    };
  }

  // RFP + MEDIUM
  if (cat === "RFP" && conf === "MEDIUM") {
    return {
      shouldCreate: true,
      title: "Validar relevância do RFP",
      dueDate: hoursFromNow(48),
      priority: "MEDIUM",
      notes: buildNotes(cat, conf, [
        "Review signal source and RFP scope",
        "Assess if opportunity matches our capabilities",
        "Check for existing relationship with the company",
        "Decide if full pursuit is warranted",
      ]),
    };
  }

  // Any category + HIGH confidence
  if (conf === "HIGH") {
    return {
      shouldCreate: true,
      title: "Contacto telefónico em 24h",
      dueDate: hoursFromNow(24),
      priority: "HIGH",
      notes: buildNotes(cat, conf, [
        "Review signal details",
        "Validate technical fit",
        "Identify decision maker",
        "Prepare initial outreach",
      ]),
    };
  }

  // Any category + LOW confidence
  if (conf === "LOW") {
    return {
      shouldCreate: true,
      title: "Qualificar oportunidade",
      dueDate: hoursFromNow(72),
      priority: "LOW",
      notes: buildNotes(cat, conf, [
        "Review available information about the company",
        "Check if signal is relevant to our offering",
        "Determine if further investigation is needed",
        "Update lead status based on findings",
      ]),
    };
  }

  // MEDIUM confidence (not RFP — already handled above)
  if (conf === "MEDIUM") {
    return {
      shouldCreate: true,
      title: "Avaliar sinal e planear abordagem",
      dueDate: hoursFromNow(48),
      priority: "MEDIUM",
      notes: buildNotes(cat, conf, [
        "Review signal details and context",
        "Assess commercial opportunity",
        "Plan appropriate outreach strategy",
        "Schedule follow-up if warranted",
      ]),
    };
  }

  return NO_ACTION;
}
