/**
 * Auto Task Engine
 *
 * After a SYSTEM activity is created, this engine checks if a TASK
 * should be auto-generated based on the signal's category and confidence.
 *
 * Responsibilities:
 * - Call deriveNextBestAction
 * - Check for duplicate open tasks (dedupe)
 * - Create TASK with structured metadata
 * - Propagate owner from lead
 *
 * @module lib/crm/autoTaskEngine
 */

import { Prisma, PrismaClient } from "@prisma/client";
import { deriveNextBestAction } from "./deriveNextBestAction";

interface AutoTaskInput {
  leadId: string;
  ownerId: string | null;
  category: string | null;
  confidence: string | null;
  systemUserId: string;
}

interface AutoTaskResult {
  created: boolean;
  taskId: string | null;
  reason: string;
}

/**
 * Check for existing open auto-generated TASK with the same category.
 * Uses notes content to detect autoGenerated marker and category match.
 */
async function hasOpenAutoTask(
  tx: Prisma.TransactionClient | PrismaClient,
  leadId: string,
  category: string | null,
): Promise<boolean> {
  const openTasks = await tx.activity.findMany({
    where: {
      leadId,
      type: "TASK",
      completedAt: null,
    },
    select: { notes: true },
  });

  const normalizedCategory = (category ?? "unknown").toUpperCase();

  return openTasks.some((task) => {
    if (!task.notes) return false;
    const hasAutoMarker = task.notes.includes("autoGenerated: true");
    const hasCategoryMatch = task.notes.includes(
      `meta.category: ${normalizedCategory}`,
    );
    return hasAutoMarker && hasCategoryMatch;
  });
}

/**
 * Auto-generate a TASK activity if the signal warrants it.
 *
 * Called after a SYSTEM activity is created (e.g., from ingest endpoint).
 * Safe to call multiple times â€” deduplication prevents duplicates.
 *
 * @param tx - Prisma transaction client (or regular client)
 * @param input - Signal metadata and lead context
 */
export async function autoGenerateTaskIfNeeded(
  tx: Prisma.TransactionClient | PrismaClient,
  input: AutoTaskInput,
): Promise<AutoTaskResult> {
  const { leadId, ownerId, category, confidence, systemUserId } = input;

  // 1. Derive the next best action
  const action = deriveNextBestAction({
    category,
    confidence: confidence as "HIGH" | "MEDIUM" | "LOW" | null,
    ownerId,
  });

  if (!action.shouldCreate) {
    return {
      created: false,
      taskId: null,
      reason: "No action recommended for this signal",
    };
  }

  // 2. Check for duplicate open task
  const hasDuplicate = await hasOpenAutoTask(tx, leadId, category);
  if (hasDuplicate) {
    return {
      created: false,
      taskId: null,
      reason: `Open auto-task already exists for category ${category ?? "unknown"}`,
    };
  }

  // 3. Create the TASK
  // Use lead owner as creator if available, otherwise system user
  const creatorId = ownerId ?? systemUserId;

  const task = await (tx as PrismaClient).activity.create({
    data: {
      leadId,
      type: "TASK",
      title: action.title,
      notes: action.notes,
      dueAt: action.dueDate,
      createdById: creatorId,
    },
  });

  return {
    created: true,
    taskId: task.id,
    reason: `Auto-generated: ${action.title} (priority: ${action.priority})`,
  };
}
