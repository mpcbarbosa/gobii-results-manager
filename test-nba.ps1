# Test script for Next Best Action engine
# Usage: .\test-nba.ps1
#
# Tests:
# 1) Create SYSTEM activity with RFP HIGH
# 2) Verify TASK auto-created
# 3) Verify no duplicate on second trigger
# 4) Verify correct dueDate window
# 5) Verify correct owner propagation

$baseUrl = "http://localhost:3000"
$ingestToken = $env:APP_INGEST_TOKEN
$adminToken = $env:APP_ADMIN_TOKEN

if (-not $ingestToken) {
    Write-Host "ERROR: APP_INGEST_TOKEN not set" -ForegroundColor Red
    exit 1
}
if (-not $adminToken) {
    Write-Host "ERROR: APP_ADMIN_TOKEN not set" -ForegroundColor Red
    exit 1
}

Write-Host "`n=== Next Best Action Engine Test ===" -ForegroundColor Cyan

# 1) Create SYSTEM activity with RFP HIGH
Write-Host "`n1) Creating SYSTEM activity (RFP + HIGH)..." -ForegroundColor Gray

$payload = @{
    company = @{
        name = "Grupo Exemplo"
        domain = "exemplo.pt"
    }
    activity = @{
        title = "RFP identificado para ERP"
        notes = "Entidade lan√ßou concurso com refer√™ncia a ERP / SAP S/4HANA."
        meta = @{
            agent = "SAP_S4HANA_RFPScanner_Daily"
            category = "RFP"
            confidence = "HIGH"
            source_url = "https://example.com/rfp/12345"
            detected_at = (Get-Date -Format "yyyy-MM-dd")
        }
    }
} | ConvertTo-Json -Depth 10

try {
    $response = Invoke-RestMethod `
        -Uri "$baseUrl/api/ingest/activity" `
        -Method Post `
        -Headers @{ Authorization = "Bearer $ingestToken"; "Content-Type" = "application/json" } `
        -Body $payload

    Write-Host "  Activity created: $($response.activityId)" -ForegroundColor Green
    if ($response.autoTaskId) {
        Write-Host "  Auto-task created: $($response.autoTaskId)" -ForegroundColor Green
    } else {
        Write-Host "  No auto-task created (may already exist)" -ForegroundColor Yellow
    }
    $leadId = $response.leadId
} catch {
    Write-Host "  ERROR: $($_.Exception.Message)" -ForegroundColor Red
    if ($_.ErrorDetails.Message) { Write-Host "  $($_.ErrorDetails.Message)" }
    exit 1
}

# 2) Verify TASK exists
Write-Host "`n2) Checking open tasks for lead..." -ForegroundColor Gray
try {
    $tasks = Invoke-RestMethod `
        -Uri "$baseUrl/api/admin/leads/$leadId/tasks" `
        -Headers @{ Authorization = "Bearer $adminToken" }

    if ($tasks.tasks.Count -gt 0) {
        Write-Host "  Open tasks: $($tasks.tasks.Count)" -ForegroundColor Green
        foreach ($task in $tasks.tasks) {
            $isAuto = if ($task.notes -and $task.notes.Contains("autoGenerated: true")) { "üß† Auto" } else { "Manual" }
            $overdue = if ($task.isOverdue) { "‚ö†Ô∏è OVERDUE" } else { "OK" }
            Write-Host "  - [$isAuto] $($task.title) | Due: $($task.dueAt) | $overdue"
        }
    } else {
        Write-Host "  No open tasks found" -ForegroundColor Yellow
    }
} catch {
    Write-Host "  ERROR: $($_.Exception.Message)" -ForegroundColor Red
}

# 3) Verify no duplicate on second trigger
Write-Host "`n3) Triggering same signal again (dedupe test)..." -ForegroundColor Gray
try {
    $response2 = Invoke-RestMethod `
        -Uri "$baseUrl/api/ingest/activity" `
        -Method Post `
        -Headers @{ Authorization = "Bearer $ingestToken"; "Content-Type" = "application/json" } `
        -Body $payload

    if ($response2.autoTaskId) {
        Write-Host "  WARNING: Duplicate task created: $($response2.autoTaskId)" -ForegroundColor Red
    } else {
        Write-Host "  PASS: No duplicate task created (dedupe working)" -ForegroundColor Green
    }
} catch {
    # Might get duplicated=true response
    Write-Host "  Response indicates duplicate signal (expected)" -ForegroundColor Green
}

# 4) Verify dueDate window
Write-Host "`n4) Checking dueDate window..." -ForegroundColor Gray
try {
    $tasks2 = Invoke-RestMethod `
        -Uri "$baseUrl/api/admin/leads/$leadId/tasks" `
        -Headers @{ Authorization = "Bearer $adminToken" }

    $autoTask = $tasks2.tasks | Where-Object { $_.notes -and $_.notes.Contains("autoGenerated: true") } | Select-Object -First 1
    if ($autoTask -and $autoTask.dueAt) {
        $dueDate = [DateTime]$autoTask.dueAt
        $hoursUntilDue = ($dueDate - (Get-Date)).TotalHours
        Write-Host "  Due in: $([math]::Round($hoursUntilDue, 1)) hours" -ForegroundColor White
        if ($hoursUntilDue -gt 0 -and $hoursUntilDue -le 25) {
            Write-Host "  PASS: Due within 24h window (RFP HIGH)" -ForegroundColor Green
        } else {
            Write-Host "  INFO: Due date is $($dueDate.ToString('yyyy-MM-dd HH:mm'))" -ForegroundColor Yellow
        }
    } else {
        Write-Host "  No auto-generated task with dueDate found" -ForegroundColor Yellow
    }
} catch {
    Write-Host "  ERROR: $($_.Exception.Message)" -ForegroundColor Red
}

Write-Host "`n=== Test Complete ===" -ForegroundColor Cyan
