# Test script for Tasks Inbox (Sprint 9)
# Usage: .\test-tasks-inbox.ps1

$baseUrl = "http://localhost:3000"
$token = $env:APP_ADMIN_TOKEN

if (-not $token) {
    Write-Host "ERROR: APP_ADMIN_TOKEN not set" -ForegroundColor Red
    exit 1
}

Write-Host "`n=== Tasks Inbox Test ===" -ForegroundColor Cyan

# 1. Fetch tasks
Write-Host "`n1) Fetching open tasks..." -ForegroundColor Gray
try {
    $response = Invoke-RestMethod `
        -Uri "$baseUrl/api/admin/tasks" `
        -Headers @{ Authorization = "Bearer $token" }

    Write-Host "Total open tasks: $($response.count)" -ForegroundColor Green

    $top10 = $response.items | Select-Object -First 10
    $tableData = @()
    foreach ($item in $top10) {
        $auto = if ($item.task.autoGenerated) { "ðŸ§ " } else { "" }
        $due = if ($item.task.dueAt) { ([DateTime]$item.task.dueAt).ToString("dd/MM HH:mm") } else { "-" }

        $tableData += [PSCustomObject]@{
            Bucket  = $item.dueBucket
            Company = $item.lead.company
            Task    = "$auto $($item.task.title)".Trim()
            Due     = $due
            Cat     = if ($item.task.metaCategory) { $item.task.metaCategory } else { "-" }
            Owner   = if ($item.lead.ownerName) { $item.lead.ownerName } else { "-" }
            Temp    = $item.lead.temperature
        }
    }
    $tableData | Format-Table -AutoSize -Wrap

    # Summary by bucket
    $overdue = ($response.items | Where-Object { $_.dueBucket -eq "OVERDUE" }).Count
    $today = ($response.items | Where-Object { $_.dueBucket -eq "TODAY" }).Count
    $week = ($response.items | Where-Object { $_.dueBucket -eq "WEEK" }).Count
    Write-Host "Overdue: $overdue | Today: $today | This week: $week" -ForegroundColor White

} catch {
    Write-Host "ERROR: $($_.Exception.Message)" -ForegroundColor Red
    exit 1
}

# 2. Reschedule first task to +3h
$firstTask = $response.items | Select-Object -First 1
if ($firstTask) {
    Write-Host "`n2) Rescheduling task to +3h..." -ForegroundColor Gray
    $newDue = (Get-Date).AddHours(3).ToString("yyyy-MM-ddTHH:mm:ss.fffZ")
    try {
        $reschedResult = Invoke-RestMethod `
            -Uri "$baseUrl/api/admin/tasks/$($firstTask.task.id)/reschedule" `
            -Method Patch `
            -Headers @{ Authorization = "Bearer $token"; "Content-Type" = "application/json" } `
            -Body (@{ dueAt = $newDue } | ConvertTo-Json)
        Write-Host "   Rescheduled to: $($reschedResult.dueAt)" -ForegroundColor Green
    } catch {
        Write-Host "   ERROR: $($_.Exception.Message)" -ForegroundColor Red
    }

    # 3. Complete it
    Write-Host "`n3) Completing task..." -ForegroundColor Gray
    try {
        $completeResult = Invoke-RestMethod `
            -Uri "$baseUrl/api/admin/leads/$($firstTask.lead.id)/tasks/complete" `
            -Method Patch `
            -Headers @{ Authorization = "Bearer $token"; "Content-Type" = "application/json" } `
            -Body (@{ taskId = $firstTask.task.id } | ConvertTo-Json)
        Write-Host "   Completed!" -ForegroundColor Green

        # Verify removed
        $response2 = Invoke-RestMethod -Uri "$baseUrl/api/admin/tasks" -Headers @{ Authorization = "Bearer $token" }
        $stillExists = $response2.items | Where-Object { $_.task.id -eq $firstTask.task.id }
        if ($stillExists) {
            Write-Host "   FAIL: Task still in inbox" -ForegroundColor Red
        } else {
            Write-Host "   PASS: Task removed from inbox (count: $($response2.count))" -ForegroundColor Green
        }
    } catch {
        Write-Host "   ERROR: $($_.Exception.Message)" -ForegroundColor Red
    }
} else {
    Write-Host "`n2-3) No tasks to test." -ForegroundColor Yellow
}

Write-Host "`n=== Test Complete ===" -ForegroundColor Cyan
